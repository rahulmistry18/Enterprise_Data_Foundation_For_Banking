version: '3.7'

services:
  # ---------------------------------------------
  # 1. PostgreSQL Database for Airflow Metadata
  # ---------------------------------------------
  postgres:
    image: postgres:15.5
    container_name: postgres_db
    hostname: postgres
    networks:
      - airflow_network
    environment:
      # Default Superuser for Postgres initialization (used by wait script)
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - "5432:5432"
    volumes:
      # Mount the table creation SQL 
      - ./scripts/utils/create_tables.sql:/docker-entrypoint-initdb.d/create_tables.sql
      # Mount the Airflow user/db creation SQL
      - ./scripts/utils/create_airflow_db_user.sql:/docker-entrypoint-initdb.d/create_airflow_db_user.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $$POSTGRES_DB -U $$POSTGRES_USER"]
      interval: 5s
      timeout: 5s
      retries: 5
    
  # ---------------------------------------------
  # 2. Airflow Environment Initialization (One-Time)
  # ---------------------------------------------
  airflow-init:
    container_name: airflow_init
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy # Wait for Postgres to be fully initialized and healthy
    networks:
      - airflow_network
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
      - AIRFLOW__WEBSERVER__SECRET_KEY=super-secret
      - POSTGRES_CONN_ID=postgres_banking_dw
    volumes:
      # Mount the consolidated initialization script
      - ./scripts/utils/init_airflow.sh:/usr/local/bin/init_airflow.sh
      # Mount the postgres wait script
      - ./scripts/utils/wait-for-postgres.sh:/usr/local/bin/wait-for-postgres.sh
    
    # FIX: Use /bin/bash explicitly to run the script, bypassing host permission issues.
    entrypoint: /bin/bash
    command: -c "/usr/local/bin/wait-for-postgres.sh postgres -- /usr/local/bin/init_airflow.sh"
    tty: true

  # ---------------------------------------------
  # 3. Airflow Webserver
  # ---------------------------------------------
  airflow-webserver:
    container_name: airflow_webserver
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully # Ensure init is done before starting
    networks:
      - airflow_network
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
      - AIRFLOW__WEBSERVER__SECRET_KEY=super-secret
      - POSTGRES_CONN_ID=postgres_banking_dw
    ports:
      - "8080:8080" # Access Airflow UI
    command: airflow webserver
    # Map the dags folder
    volumes:
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./scripts/utils:/opt/airflow/scripts/utils

  # ---------------------------------------------
  # 4. Airflow Scheduler
  # ---------------------------------------------
  airflow-scheduler:
    container_name: airflow_scheduler
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully # Ensure init is done before starting
    networks:
      - airflow_network
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
      - AIRFLOW__WEBSERVER__SECRET_KEY=super-secret
      - POSTGRES_CONN_ID=postgres_banking_dw
    command: airflow scheduler
    # Map the dags folder
    volumes:
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./scripts/utils:/opt/airflow/scripts/utils
      
# ---------------------------------------------
# 5. Network Definition
# ---------------------------------------------
networks:
  airflow_network:
    name: banking_airflow_network